<div class="modal" id="subscription-checker-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="color:red;">Your Subscription Has Expired</h4>
            </div>
            <div class="modal-body">
<#if userInAdminRole >
      <p>${adminMessage}</p>
      <p>Subscription key: groupId: ${subscriptionGroupId} | artifactId: ${subscriptionArtifactId} | version: ${subscriptionVersion}</p>
      <div id="systemId-content"></div>
<#else>
      <p>${userMessage}</p>
</#if>
            </div>
            <div class="modal-footer">
                <div id="textout"></div>
                <button id="subscription-checker-acknowledge" type="button" class="btn btn-success" data-dismiss="modal">Acknowledge this message</button>
            </div>
        </div>
    </div>
</div>

<!--  expected responses authenticated or not -->
<!--  http://demo1.opennms.co.uk:8980/opennms/licencemgr/rest/v1-0/licence-mgr/isauthenticated?productId= -->
<!--  status 400<?xml version="1.0" encoding="UTF-8" standalone="yes"?><errorMessage><status>400</status><message>Licence not installed for productId=myproject/1.0-SNAPSHOT</message><code>0</code></errorMessage>-->
<!--  status 200 <?xml version="1.0" encoding="UTF-8" standalone="yes"?><replyMessage><replyComment>Licence is not authenticated for productId=myproject/1.0-SNAPSHOT</replyComment><productId>myproject/1.0-SNAPSHOT</productId><isAuthenticated>false</isAuthenticated></replyMessage> -->

<script type="text/javascript">
(function(){
    $(document).ready(function() {
    	console.log('ackSubscriptionExpired:'+ sessionStorage.getItem('ackSubscriptionExpired'));
    	if (sessionStorage.getItem('ackSubscriptionExpired')===null){
        	var authenticated=false;
        	$.get('licencemgr/rest/v1-0/licence-mgr/isauthenticated?productId=${subscriptionArtifactId}/${subscriptionVersion}')
    	      .done( function(data,textStatus,jqXHR) {
    		      responseText=jqXHR.responseText;
    	          console.log('is authenticated response text' + responseText);
    		      if(responseText.includes('<isAuthenticated>true')) authenticated=true;
    		      console.log('is authenticated: '+authenticated);
        	      if(! authenticated){
        		     $('#subscription-checker-modal').modal('show');
        	      }
        	   })
        	  .fail( function(jqXHR, textStatus, errorThrown) {
        		  responseText=jqXHR.responseText;
        		  console.log('fail textStatus:' +textStatus
        				  +' errorThrown:'+errorThrown
        				  +' response text:' + responseText);
        		  $('#subscription-checker-modal').modal('show');
        	  });
           $.get('licencemgr/rest/v1-0/licence-mgr/getsystemid')
  	         .done( function(data,textStatus,jqXHR) {
  		         responseText=jqXHR.responseText;
  		         systemId='unavailable'
  	             console.log('system id response text' + responseText);
  		         if(responseText.includes('<systemId>')) {
  		        	start = responseText.indexOf('<systemId>')+'<systemId>'.length;
  		        	end = responseText.indexOf('</systemId>')
  		        	systemId=responseText.substr(start, end);
  		        	console.log('systemId: '+systemId);
  		        	$('#systemId-content').html('System Id: '+systemId);
  		         }
      	   });
        	
    	};

   		$('#subscription-checker-modal').on('shown.bs.modal', function () {
   		    $(this).find('.modal-dialog').css({height:'auto', 'max-height':'100%'});
   			$('#subscription-checker-enable').focus();
 		});
   		
    	$('#subscription-checker-acknowledge').click(function() {
    		sessionStorage.setItem('ackSubscriptionExpired',true);
    		console.log('ackSubscriptionExpired set: '+ sessionStorage.getItem('ackSubscriptionExpired'));
    	});
    	
    });
})();

</script>
